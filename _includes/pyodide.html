<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5/lib/codemirror.css">
<script src="https://cdn.jsdelivr.net/npm/codemirror@5/lib/codemirror.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5/mode/python/python.js"></script>

<style>
.interactive-code {
    position: relative;
    margin-bottom: 1em;
}
.code-editor {
    border: 1px solid #ccc;
    margin-bottom: 1em;
}
.output {
    background-color: #f7f7f7;
    padding: 10px;
    border: 1px solid #ddd;
    white-space: pre-wrap;
    margin-top: 10px;
}
.run-button {
    position: absolute;
    right: 10px;
    top: 10px;
    z-index: 10;
    padding: 5px 10px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}
.run-button:hover {
    background: #45a049;
}
</style>

<script>
async function createPyodideInstance(elementId) {
    const pyodide = await loadPyodide();
    await pyodide.loadPackage(['numpy', 'matplotlib']);
    
    const editor = CodeMirror(document.getElementById(`editor-${elementId}`), {
        value: document.getElementById(`code-${elementId}`).textContent,
        mode: 'python',
        theme: 'default',
        lineNumbers: true,
        viewportMargin: Infinity,
        lineWrapping: true
    });

    document.getElementById(`run-${elementId}`).addEventListener('click', async () => {
        const output = document.getElementById(`output-${elementId}`);
        output.textContent = 'Running...';
        
        try {
            // Clear previous matplotlib plots
            await pyodide.runPythonAsync('import matplotlib.pyplot as plt; plt.clf()');
            
            // Run the code
            const code = editor.getValue();
            await pyodide.runPythonAsync(code);
            
            // Get the plot if one was created
            const plotElements = document.getElementsByClassName('plot-output');
            while(plotElements.length > 0) {
                plotElements[0].parentNode.removeChild(plotElements[0]);
            }
            
            try {
                const fig = await pyodide.runPythonAsync(`
                    import matplotlib.pyplot as plt
                    plt.gcf()
                `);
                const plotDiv = document.createElement('div');
                plotDiv.className = 'plot-output';
                output.appendChild(plotDiv);
                await fig.show(plotDiv);
            } catch (e) {
                // No plot to show
            }
            
        } catch (err) {
            output.textContent = 'Error: ' + err.message;
        }
    });
}
</script>